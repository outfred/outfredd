Implement fully-local AI search + outfit generator + image generation with automation, tests, and debug tooling

๐จ ุงููุญุชูู (Arabic spec)

ูุฑุญุจูุงุ
ุฃุฑูุฏ ุชุญููู ุงููุดุฑูุน ููุนูู ูุญูููุง ุจุงููุงูู ุจุฏูู ุฃู ูุฒููุฏุงุช ุฎุงุฑุฌูุฉุ ุจุญูุซ ูู ูููุฒุงุช ุงูุจุญุซ ุงูุฐูู (ูุต + ุตูุฑุฉ) ูููููุฏ ุงูุฃูุชููุช ูุชูููุฏ ุงูุตูุฑ ุชุนูู ูู ุงูุฎุงุฏู/ุงูุณูุฑูุฑ ุงูุฎุงุต ุจุงููููุน ููุท. ุฑุฌุงุก ุชูููุฐ ุงูุชุงูู ุญุฑูููุง:

1) ุงููุชุทูุจุงุช ุงูุนุงูุฉ (Local-only)

ููููุน ุงุณุชุฏุนุงุก ุฃู API ุฎุงุฑุฌู (ูุง OpenAI ููุง Groq ููุง Qdrant Cloud ููุง Stable-Diffusion SaaS).

ูู ุงูููุฏููุงุช ุชูุญูููู ูุญูููุง ูุฑุฉ ูุงุญุฏุฉุ ูููุชุงุญ ุชุดุบูููุง ุฏูู ุฅูุชุฑูุช ุจุนุฏ ุงูุชุญููู.

ุถุน ูู ุงูุฅุนุฏุงุฏุงุช ูู .envุ ูุงุฌุนู ููุงู ููุชุงุญ DEBUG=1 ููุนูู ููุฌ ุชูุตููู.

2) ุงููููููุงุช (Services) ูุงูููุงูุฐ

Ollama (LLM ููุฃูุชููุช/ุงูุชูุณูุฑ) ุนูู :11434 ูุน ููุฏูู ุงูุชุฑุงุถู llama3.1:8b (ูุงูุจุฏูู qwen2.5:7b).

Qdrant (Vector DB ูุญูู) ุนูู :6333 ูุน Collection ุงุณููุง products.

Text Embeddings (ุจุงูุซูู FastAPIุ ููุฏูู BAAI/bge-m3) ุนูู :7001.

Image Embeddings (ุจุงูุซูู FastAPIุ OpenCLIP ViT-B/32) ุนูู :7002.

Reranker (ุจุงูุซูู FastAPIุ BAAI/bge-reranker-v2-m3) ุนูู :7003.

API Gateway (Node/Express) ุนูู :5000 ูุนุฑูู ูู ุงูู endpoints ูููููุน.

ููุงุญุธุฉ: ุดุบูู Ollama ูุญูููุง ุฎุงุฑุฌ ุงูู compose ุงูุชุฑุงุถููุงุ ููููุฑ ุณุทุฑ ุชุนููู ูุดุฑุญ ููู ูุถููู ููู compose ูุงุญููุง.

3) ููู docker-compose

ูุฏูู docker-compose.yml ูุดุบูู: qdrant, text-emb, img-emb, reranker, search-api.
ุฃูุซูุฉ ENV (ุถุนูุง ูู .env ููุฑูุฑูุง ููุฎุฏูุงุช):

QDRANT_URL=http://qdrant:6333
TEXT_EMB_URL=http://text-emb:7001/embed
IMG_EMB_URL=http://img-emb:7002/embed
RERANK_URL=http://reranker:7003/rerank
OLLAMA_URL=http://host.docker.internal:11434
DEBUG=1

4) ุงูู API ุงููุทููุจ (ูู ุงููููุน ููุณู)
4.1) POST /api/search

Body:

{ "query": "string?", "imageBase64": "data:image/png;base64,...?", "topK": 24 }


ุงูููุทู:

Normalize ููู query (ูุงููุณ ุนุฑุจูโุฅูุฌููุฒู + ุชุตุญูุญ ุฅููุงุฆู ุจุณูุท โููุฏูโhoodieโ).

ูู ุตูุฑุฉ: ุงุญุณุจ image embedding ูู ุฎุฏูุฉ img-embุ ูุฅููุง text embedding ูู text-emb.

ุงุจุญุซ ูู Qdrant (collection: products, with_payload=true, limit=topK).

ูู ููู query ูุตู: ุฃุนุฏ ุชุฑุชูุจ ุงููุชุงุฆุฌ ุนุจุฑ reranker.

ุงุฑุฌุน ุงููุชุงุฆุฌ (id, score, payload {...}).

Logs ุนูุฏ DEBUG=1: ุฃุฒููุฉ ูู ุฎุทูุฉ (ms)ุ ุญุฌู/ุฃุจุนุงุฏ ุงูู vectorsุ ุนุฏุฏ ุงููุชุงุฆุฌ ูุจู/ุจุนุฏ rerankุ request-id.

4.2) POST /api/outfit/generate

Body:

{ "gender":"unisex|male|female", "season":"all|summer|winter|...", "vibe":"casual|street|...", "budget":"low|mid|high", "picks":[{"id":"...","title":"...","price":123}] }


ุงูููุทู:

ุฃุฑุณู Prompt ูููููู ุฅูู Ollama (model llama3.1:8b) ููุฑุฌุน JSON ุจุงูุตูุบุฉ:

{
  "items": [{"id": "or null", "title": "...", "why": "..."}],
  "total_estimate": 0,
  "style_notes": "ูุต ุนุฑุจู ููุฌุฒ"
}


ุฃู ุฅุฎุฑุงุฌ ุบูุฑ JSON ููู: ุญุงูู ุฅุตูุงุญู (parse/repair). ูู ูุดู โ 500 ุจุฑุณุงูุฉ ูุงุถุญุฉ.

4.3) POST /api/image/generate

ูุญูู ุจุงููุงูู ุนุจุฑ Stable Diffusion ูุญูู:

ุฌููุฒ ุฎูุงุฑูู (switch ุจุงูุจูุฆุฉ):

ComfyUI ูุญูู (ุงูุชุฑุงุถููุง http://localhost:8188) ูุน ูุฑุดุฉ/graph ุฌุงูุฒ ูุงุณุชูุจุงู Prompt ูุฅุฑุฌุงุน ุตูุฑุฉ Base64.

ุฃู FastAPI ุจุฏุงุฎู ุงููุดุฑูุน ุจู diffusers (SD 1.5/SDXL/SD-Turbo) ูุนุฑูู:
Body: { "prompt":"...", "width":512, "height":512, "seed": null, "steps": 20 }
Response: { "imageBase64": "data:image/png;base64,..." }

ููููุน ุงุณุชุฏุนุงุก ุฃู ูููุฏ ุตูุฑ ุฎุงุฑุฌู.

5) ููุฑุณุฉ ุงูุจูุงูุงุช (Indexer) + Webhook

ุณูุฑุจุช Indexer (Node ุฃู Python):

ููุฑุฃ ูุงุฆูุฉ ุงูููุชุฌุงุช (JSON/DB)ุ ููููู ูุตูุง (title + desc + tags + brand + color โฆ)ุ

ูุณุชุฏุนู text-emb ู/ุฃู img-emb ุซู upsert ููุงุท ูู Qdrant (id, vector, payload).

Webhook/Admin: ุนูุฏ ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ููุชุฌ โ ุฅุฏุฎุงู Job ูQueue ุตุบูุฑุฉ (ูุซูุง BullMQ/Redis ุฃู in-memory fallback) ูุชุญุฏูุซ ุงูููุฑุณ ุชุฏุฑูุฌููุง.

ูุฏุนู re-embed ุงูุชูุงุฆู ููููู ุงุชุจุฏูู ููุท (hash ูููุญุชูู ูุชูููู ุงูุชูููุฉ).

6) ุงููุงููุณ ุงูุนุฑุจูโุงูุฅูุฌููุฒู + ุชุตุญูุญ ุงูุฅููุงุก

ููู JSON ูุญูู ุจุงููุตุทูุญุงุช (hoodie/ููุฏูุ ุฌุงููุชุ ุชู-ุดูุฑุชุ ุฃููุฑุณุงูุฒุ ุฑุจุน-ุณุณุชุฉโฆ ุฅูุฎ)

ุงุณุชุฎุฏู rapidfuzz ุฃู SymSpell ูุญูู ููููุฒูู ูุงุชุด.

ุฃู ุงุณุชุนูุงู ุจุฏูู ูุชุงุฆุฌ โ ููุณุฌูู ูู ููุฌ misses.log ููุฑุงุฌุนุฉ ุฃุณุจูุนูุฉ.

7) ุงูุงุฎุชุจุงุฑุงุช (ูุทููุจุฉ) + CI
7.1) Node (Jest + Supertest) ูู api/__tests__

search.spec.ts:

ุนุฑุจูโุฅูุฌููุฒู: โููุฏูโ ุชูุฑุฌุน ูุชุงุฆุฌ ุฐุงุช ุตูุฉ (payload.title/brand).

ุตูุฑุฉ Base64 ุตุบูุฑุฉ โ ูุญุตู vector ููุฑุฌุน ูุชุงุฆุฌ.

ุนุฏู ูุฌูุฏ query ูู image โ 400.

outfit.spec.ts:

ูุฑุฌุน JSON ุตุญูุญ ุจุงูููุงุชูุญ ุงููุฐููุฑุฉ.

ูุชุญููู ูุฏุฎูุงุช ูุงูุตุฉ (defaults).

image.spec.ts:

ููููุฏ ุตูุฑุฉ Base64 ุตุญูุญุฉ ุจุฅุนุฏุงุฏุงุช ุจุณูุทุฉ (ูู ComfyUI ุบูุฑ ูุชุงุญุ ุงุฎุชุจุฑ ูุณุงุฑ diffusers).

npm scripts:

"dev": "nodemon server.js",
"test": "jest --runInBand",
"lint": "eslint ."

7.2) Python (pytest) ููู ุฎุฏูุฉ

text-emb: ุทูู/ุฃุจุนุงุฏ ุซุงุจุชุฉ + normalized.

img-emb: ููุจู PNG ุตุบูุฑุฉ ูููุฑุฌุน vector normalized.

reranker: ุชุฑุชูุจ ูุฎุชูู ุนูุฏ ุชุบููุฑ query.

7.3) CI

ููู GitHub Actions /.github/workflows/ci.yml ูุดุบู:

build + lint + tests (Node ู Python)

ูููุน ุงูุฏูุฌ ุนูู main ูู ุฃู ูุดู.

8) ุงูู Debug & Observability

Request-ID ูุฑูุฏ ุจูู ุทูุจุ ููุชูู ุจูู ุงูุฎุฏูุงุช.

ูุงุฌูุฉ /api/health ุชูุฑุฌุน JSON counters:

latency ุงููุชูุณุท ููู ุฎุทูุฉุ ุนุฏุฏ ุงูุงุณุชุฏุนุงุกุงุชุ ูุณุจุฉ zero-resultsุ ุขุฎุฑ snapshot Qdrantโฆ

ุนูุฏ DEBUG=1:

ุงุทุจุน ุฒูู ูู ุฎุทูุฉ (embedding/search/rerank/ollama/image) ุจุงููููู ุซุงููุฉ.

ูุตู Base64 ุงูุทูููุฉ ูู ุงูููุฌ.

9) ุฌูุจุฒ ูุฌุฏููุฉ (Cron) ูุญููุฉ

ูููููุง:

Re-embed ููููุชุฌุงุช ุงูุชู ุชุบููุฑุช ููุท (ููู hash).

Snapshot/compact ูู Qdrant (ุญูุธ ูู ูุฌูุฏ ./backups/qdrant/).

ุฃุณุจูุนููุง:

ุชูููู ุฌูุฏุฉ ุงูุจุญุซ ุนูู Benchmark ุตุบูุฑ (NDCG/Recall@K) ูู queries ุญููููุฉ + ุชูุฑูุฑ HTML/CSV.

ูุฑุงุกุฉ misses.log ูุงูุชุฑุงุญ ุชุญุฏูุซุงุช ูููุงููุณ (ููู synonyms.pending.json)ุ ูุชูููุฑ ุณูุฑุจุช โapplyโ ูุชุญุฏูุซ ุงููุงููุณ ูุฏูููุง.

10) ูุนุงููุฑ ุงููุจูู (Acceptance)

docker compose up ููุทูู ูู ุงูุฎุฏูุงุช ุจูุง ุฃุฎุทุงุก.

npm test (Node) ูpytest (Python) ููุฑุงู ุจูุฌุงุญ.

POST /api/search ุจูููุฉ "ููุฏู" ููุฑุฌุน ูุชุงุฆุฌุ ูุน ููุฌ ููุฃุฒููุฉ ูุนุฏุฏ ุงููุชุงุฆุฌ ูุจู/ุจุนุฏ rerank.

POST /api/outfit/generate ููุฑุฌุน JSON ุนุฑุจู ููุฌุฒ ุจุตูุบุฉ ุตุญูุญุฉ.

POST /api/image/generate ููููุฏ ุตูุฑุฉ Base64 ูุญูููุง (ComfyUI ุฃู diffusers).

ููุฏ ูุธูู + ุชุนูููุงุช ูุตูุฑุฉ ุฃุนูู ุงููููุงุช ุชุดุฑุญ ูู ุฎุฏูุฉ.

11) ุงูุชุณููู

ุงุฏูุนูุง ุงูุชุบููุฑุงุช ุนูู ูุฑุน: feat/local-ai-engine

ุงูุชุญูุง PR ูุน ุดุฑุญ: ุงูุจููุฉุ ุงูุฃูุงูุฑุ ูููููุฉ ุงูุชุดุบูู ูุญูููุงุ ูููุทุงุช ูู ุงูู logs ูุงูุงุฎุชุจุงุฑุงุช.

ุชุฃููุฏ ููุงุฆู: ูู ูุง ุณุจู ูุญูู ุจุงููุงูู โ ูุง ุชุณุชุนูููุง ุฃู API ุฎุงุฑุฌู ุฅุทูุงููุง.

(ุงุฎุชูุงุฑู) English short copy

Please refactor the project to run fully on local components (no external APIs) for:

Smart Search (text+image) โ bge-m3, OpenCLIP, Qdrant, local reranker

Outfit Generator โ Ollama (llama3.1:8b)

Image Generation โ local ComfyUI or diffusers (SD1.5/SDXL)
Include docker-compose, indexer, webhook/queue, Jest+pytest tests, CI workflow, debug logs, cron jobs, and clear acceptance criteria as specified above. Deliver via PR feat/local-ai-engine.